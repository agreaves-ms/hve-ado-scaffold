---
mode: 'agent'
description: 'Stages all changes, generates a conventional commit message, shows it to the user, and commits using only git add/commit'
---

# Stage, Generate, and Commit

Must follow all instructions provided by #file:../instructions/commit-message.instructions.md

Protocol:
1. Stage all unstaged changes using ONLY: `git add -A` (no other git commands at this step).
2. Use the `get_changed_files` tool to retrieve the now-staged changes (DO NOT use git diff / show / status / log / fetch / pull / push).
3. Analyze the staged changes and produce a clean Conventional Commit message (per the commit message instructions file referenced above).
4. Output a line to the user: `I will be making a commit with the following commit:` followed immediately by a blank line, then the full commit message inside a fenced `markdown` code block (same style as examples below). This output is the authoritative message.
5. After printing that preview (without waiting for confirmation), commit the staged changes using ONLY allowed git commands:
  - Pipe the exact commit message (including body + footer emoji line) via STDIN: `echo "<full message>" | git commit -F -`.
  - Preserve newlines exactly; ensure the footer emoji line is the final line (file ends with a newline).
  - DO NOT run any other git commands (no push, pull, fetch, diff, show, status, log, branch, switch, merge, rebase, tag, etc.).
6. After the commit succeeds, print a single confirmation sentence AFTER the code block (e.g. `Commit created.`). Do not expose internal tool output unless an error occurs.

Rules & Constraints:
- Allowed git commands: `git add -A`, `git commit -F -` (stdin) or `git commit -m` variants if single-line only (multi-line must use `-F -`). Nothing else.
- Never attempt to obtain diffs via git CLI; rely solely on `get_changed_files` tool output.
- If there are NO staged changes after staging, output a short notice and STOP (do not create an empty commit).
- Commit message MUST:
  - Use an allowed type and optional allowed scope.
  - Be present tense.
  - Keep description under 4 specific change points (comma-separated concise phrases).
  - Include an optional body ONLY for large, wide-reaching changes (list bullet points starting each line with `- `) preceded by a blank line.
  - Include a footer line starting with a blank line, containing an emoji, a space, `- Generated by Copilot`.
- Never wait for confirmation for any step in the Protocol.

Output Format:
- When proceeding (changes present):
  - First print the exact line: `I will be making a commit with the following commit:`
  - Then a blank line.
  - Then the commit message inside a fenced ```markdown code block.
  - After the code block, print a single confirmation sentence.
- For no-change scenario, skip code block and print: `No changes to commit.`

Example for a large change (structure illustration):
<!-- <example-commit-and-commit-action-large> -->
Here's the clean, conventional commit message based on the staged changes:

```markdown
feat: add repo-wide instruction files including prompts and chatmodes

- add commit message, markdown, C# along with C# test instructions
- introduce task planner and researcher, prompt builder, and adr creation chatmodes
- configure markdownlint and VS Code workspace settings
- add ADO work items prompts for getting and preparing my work items
- add .gitignore and cleanup README newlines

ðŸ§­ - Generated by Copilot
```
Commit created.
<!-- </example-commit-and-commit-action-large> -->

Example for a medium/small change:
<!-- <example-commit-and-commit-action> -->
Here's the clean, conventional commit message based on the staged changes:

```markdown
feat(prompts): update summarize-my-work-items.prompt.md to clarify json output, correct get-my-work-items.prompt.md to fallback to wit_my_work_items

ðŸ”’ - Generated by Copilot
```
Commit created.
<!-- </example-commit-and-commit-action> -->

Error Handling:
- If `git commit` fails (e.g., hooks reject), report a concise error summary with suggested fix and STOP without retries.

Proceed now following the protocol.
